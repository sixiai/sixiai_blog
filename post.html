<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç«  - å››å¤•çš„åšå®¢å°ç«™</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- æ•°å­¦å…¬å¼ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body>
    <!-- é˜…è¯»è¿›åº¦æ¡ -->
    <div class="reading-progress" id="readingProgress"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <i class="fas fa-code"></i>
                <span>å››å¤•çš„åšå®¢</span>
            </a>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> é¦–é¡µ
                </a>
                <a href="archives.html" class="nav-link">
                    <i class="fas fa-archive"></i> å½’æ¡£
                </a>
                <a href="tags.html" class="nav-link">
                    <i class="fas fa-tags"></i> æ ‡ç­¾
                </a>
                <a href="about.html" class="nav-link">
                    <i class="fas fa-user"></i> å…³äº
                </a>
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- æ–‡ç« å†…å®¹ -->
    <main class="main-content post-page">
        <article class="post-container">
            <!-- æ–‡ç« å¤´éƒ¨ -->
            <header class="post-header" id="postHeader">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>åŠ è½½ä¸­...</span>
                </div>
            </header>

            <!-- æ–‡ç« æ­£æ–‡ -->
            <div class="post-content markdown-body" id="postContent">
                <!-- Markdown å†…å®¹å°†æ¸²æŸ“åˆ°è¿™é‡Œ -->
            </div>

            <!-- æ–‡ç« åº•éƒ¨ -->
            <footer class="post-footer">
                <div class="post-nav">
                    <a href="index.html" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                    </a>
                </div>
                <div class="post-share">
                    <span>åˆ†äº«åˆ°ï¼š</span>
                    <a href="#" class="share-link" title="åˆ†äº«åˆ°å¾®åš">
                        <i class="fab fa-weibo"></i>
                    </a>
                    <a href="#" class="share-link" title="åˆ†äº«åˆ°Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                </div>
            </footer>
        </article>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>Â© 2025 å››å¤•çš„åšå®¢å°ç«™</p>
                    <p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>
                </div>
                <div class="footer-links">
                    <a href="https://github.com/sixiai" target="_blank">
                        <i class="fab fa-github"></i> GitHub
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- å›åˆ°é¡¶éƒ¨ -->
    <button class="back-to-top" id="backToTop" title="å›åˆ°é¡¶éƒ¨">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- ç›®å½•ä¾§è¾¹æ  -->
    <aside class="toc-sidebar" id="tocSidebar">
        <div class="toc-header">
            <i class="fas fa-list"></i> ç›®å½•
        </div>
        <nav class="toc-content" id="tocContent">
            <!-- ç›®å½•å°†é€šè¿‡ JS ç”Ÿæˆ -->
        </nav>
    </aside>

    <script src="js/main.js"></script>
    <script>
        // é…ç½® marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // è·å–æ–‡ç«  ID
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        // ä» posts.json ç»Ÿä¸€åŠ è½½æ–‡ç« æ•°æ®
        async function loadPost() {
            if (!postId) {
                showError('æœªæŒ‡å®šæ–‡ç« ');
                return;
            }

            try {
                // ä» posts.json è·å–æ–‡ç« åˆ—è¡¨
                const response = await fetch('posts/posts.json');
                const data = await response.json();
                const postInfo = data.posts.find(p => p.id === postId);

                if (!postInfo) {
                    showError('æ–‡ç« ä¸å­˜åœ¨');
                    return;
                }

                // åŠ è½½ Markdown æ–‡ä»¶
                const mdResponse = await fetch(`posts/${postInfo.file}`);
                if (!mdResponse.ok) {
                    throw new Error('æ–‡ç« åŠ è½½å¤±è´¥');
                }
                const markdown = await mdResponse.text();

                // æ¸²æŸ“æ–‡ç« 
                renderPost(postInfo, markdown);

            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                showError('åŠ è½½æ–‡ç« å¤±è´¥ï¼Œæœ¬åœ°é¢„è§ˆè¯·ä½¿ç”¨ Live Server');
            }
        }

        // æ¸²æŸ“æ–‡ç« 
        function renderPost(info, markdown) {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = `${info.title} - å››å¤•çš„åšå®¢å°ç«™`;

            // æ¸²æŸ“å¤´éƒ¨
            document.getElementById('postHeader').innerHTML = `
                <div class="post-meta">
                    <span class="post-date">
                        <i class="far fa-calendar-alt"></i> ${info.date}
                    </span>
                    <div class="post-tags">
                        ${info.tags.map(tag => `<span class="tag tag-${tag}">${getTagName(tag)}</span>`).join('')}
                    </div>
                </div>
                <h1 class="post-title">${info.title}</h1>
            `;

            // æ¸²æŸ“ Markdown å†…å®¹
            // ç§»é™¤ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼ˆå› ä¸ºå·²ç»åœ¨å¤´éƒ¨æ˜¾ç¤ºäº†ï¼‰
            const lines = markdown.split('\n');
            let startIndex = 0;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('# ')) {
                    startIndex = i + 1;
                    break;
                }
            }
            // åŒæ—¶ç§»é™¤å…ƒä¿¡æ¯è¡Œï¼ˆ> ğŸ“… å¼€å¤´çš„è¡Œï¼‰
            while (startIndex < lines.length && (lines[startIndex].trim() === '' || lines[startIndex].startsWith('>'))) {
                startIndex++;
            }
            const contentMarkdown = lines.slice(startIndex).join('\n');

            const htmlContent = marked.parse(contentMarkdown);
            document.getElementById('postContent').innerHTML = htmlContent;

            // ä»£ç é«˜äº®
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            renderMathInElement(document.getElementById('postContent'), {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // ç”Ÿæˆç›®å½•
            generateTOC();
        }

        // ç”Ÿæˆç›®å½•
        function generateTOC() {
            const content = document.getElementById('postContent');
            const headings = content.querySelectorAll('h2, h3');
            const tocContent = document.getElementById('tocContent');

            if (headings.length === 0) {
                document.getElementById('tocSidebar').style.display = 'none';
                return;
            }

            let tocHTML = '<ul>';
            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                const level = heading.tagName === 'H2' ? 'toc-h2' : 'toc-h3';
                tocHTML += `<li class="${level}"><a href="#${id}">${heading.textContent}</a></li>`;
            });
            tocHTML += '</ul>';

            tocContent.innerHTML = tocHTML;

            // ç›®å½•ç‚¹å‡»æ»šåŠ¨
            tocContent.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').slice(1);
                    const target = document.getElementById(targetId);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }

        // è·å–æ ‡ç­¾åç§°
        function getTagName(tag) {
            const tagNames = {
                'stm32': 'STM32',
                'matlab': 'Matlab',
                'knowledge': 'çŸ¥è¯†',
                'documentation': 'æ–‡æ¡£'
            };
            return tagNames[tag] || tag;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('postHeader').innerHTML = '';
            document.getElementById('postContent').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <h2>å‡ºé”™äº†</h2>
                    <p>${message}</p>
                    <a href="index.html" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
                </div>
            `;
        }

        // é˜…è¯»è¿›åº¦æ¡
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById('readingProgress').style.width = scrolled + '%';
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadPost);
    </script>
</body>
</html>
